from public import db
from libs.model import ModelMixin
# from apps.system.models import NotifyWay


'''class Image(db.Model, ModelMixin):
    __tablename__ = 'deploy_images'

    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(50), unique=True)
    desc = db.Column(db.String(255))

    @property
    def latest(self):
        tag = ImageTag.query.filter_by(image_id=self.id).order_by(ImageTag.created.desc()).first()
        if not tag:
            raise Exception('Not has valid image tag')
        return tag.name

    def __repr__(self):
        return '<Image %r>' % self.name

    class Meta:
        ordering = ('-id',)'''


class Exploit(db.Model, ModelMixin):
    __tablename__ = 'exploit'

    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    name = db.Column(db.String(255))
    cve = db.Column(db.String(255))
    affect_version = db.Column(db.String(255))
    os = db.Column(db.String(255))
    desc = db.Column(db.String(255))
    enter_time = db.Column(db.String(255))
    update_time = db.Column(db.String(255))
    category_id = db.Column(db.ForeignKey(
        'application.id', ondelete='CASCADE'))
    vul_type_id = db.Column(db.ForeignKey('vul_type.id', ondelete='CASCADE'))
    application_id = db.Column(db.ForeignKey(
        'application.id', ondelete='CASCADE'))
    vullevel_id = db.Column(db.ForeignKey('level.id', ondelete='CASCADE'))
    language_id = db.Column(db.ForeignKey('language.id', ondelete='CASCADE'))
    effect_id = db.Column(db.ForeignKey('effect.id', ondelete='CASCADE'))
    user_id = db.Column(db.ForeignKey('account_users.id', ondelete='CASCADE'))
    plugin_file_path = db.Column(db.String(255))
    standalone_tool_file_path = db.Column(db.String(255))
    docker_file_path = db.Column(db.String(255))
    virtual_machine_remarks = db.Column(db.Text)

    def __repr__(self):
        return '<Exploit name=%r, cve=%r>' % (self.name, self.cve)


class VulType(db.Model, ModelMixin):
    __tablename__ = 'vul_type'

    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    name = db.Column(db.String(255))
    desc = db.Column(db.String(255))

    def __repr__(self):
        return '<VulType %r>' % self.name


class Category(db.Model, ModelMixin):
    __tablename__ = 'category'

    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    name = db.Column(db.String(255))

    def __repr__(self):
        return '<Category %r>' % self.name


class Application(db.Model, ModelMixin):
    __tablename__ = 'application'

    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    name = db.Column(db.String(255))

    def __repr__(self):
        return '<Application %r>' % self.name


class Level(db.Model, ModelMixin):
    __tablename__ = 'level'

    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    name = db.Column(db.String(255))

    def __repr__(self):
        return '<Level %r>' % self.name


class Language(db.Model, ModelMixin):
    __tablename__ = 'language'

    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    name = db.Column(db.String(255))

    def __repr__(self):
        return '<Language %r>' % self.name


class Effect(db.Model, ModelMixin):
    __tablename__ = 'effect'

    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    name = db.Column(db.String(255))

    def __repr__(self):
        return '<Effect %r>' % self.name


'''class History(db.Model, ModelMixin):
    __tablename__ = 'deploy_history'

    id = db.Column(db.Integer, primary_key=True)
    app_id = db.Column(db.Integer, db.ForeignKey('deploy_apps.id', ondelete='CASCADE'))
    host_id = db.Column(db.Integer, db.ForeignKey('assets_hosts.id', ondelete='CASCADE'))
    env_id = db.Column(db.Integer, db.ForeignKey('configuration_environments.id', ondelete='CASCADE'))
    api_token = db.Column(db.String(32))
    deploy_message = db.Column(db.String(255))
    deploy_restart = db.Column(db.Boolean)
    deploy_success = db.Column(db.Boolean)
    created = db.Column(db.String(20))

    class Meta:
        ordering = ('-id',)


class App(db.Model, ModelMixin):
    __tablename__ = 'deploy_apps'

    id = db.Column(db.Integer, primary_key=True)
    identify = db.Column(db.String(50))
    name = db.Column(db.String(50))
    desc = db.Column(db.String(255))
    group = db.Column(db.String(50))

    image_id = db.Column(db.Integer, db.ForeignKey('deploy_images.id'))
    notify_way_id = db.Column(db.Integer, db.ForeignKey('notify_way.id'))

    image = db.relationship(Image)
    notify_way = db.relationship(NotifyWay)
    menus = db.relationship('DeployMenu', secondary='deploy_app_menu_rel')
    fields = db.relationship('DeployField', secondary='deploy_app_field_rel')

    def __repr__(self):
        return '<App %r>' % self.name

    class Meta:
        ordering = ('-id',)


class AppHostRel(db.Model, ModelMixin):
    __tablename__ = 'deploy_app_host_rel'

    id = db.Column(db.Integer, primary_key=True)
    env_id = db.Column(db.Integer, db.ForeignKey('configuration_environments.id'))
    app_id = db.Column(db.Integer, db.ForeignKey('deploy_apps.id'))
    host_id = db.Column(db.Integer, db.ForeignKey('assets_hosts.id'))

    def __eq__(self, other):
        return other.env_id == self.env_id and other.app_id == self.app_id and other.host_id == self.host_id


class DeployMenu(db.Model, ModelMixin):
    __tablename__ = 'deploy_menus'

    id = db.Column(db.Integer, primary_key=True)
    # 属于哪个应用的菜单
    app_id = db.Column(db.Integer, db.ForeignKey('deploy_apps.id', ondelete='CASCADE'), nullable=True)
    # 菜单的显示名称
    name = db.Column(db.String(50))
    # 菜单的帮助及描述
    desc = db.Column(db.String(255))
    # 菜单展示的位置（发布: 1 / 更多: 2）
    position = db.Column(db.SmallInteger)
    # 执行结果展示方式 （页面实时输出: 1 / 仅通知成功与否: 2）
    display_type = db.Column(db.SmallInteger)
    # 执行的钩子（自定义命令）
    command = db.Column(db.Text)
    # 是否需要传入参数
    required_args = db.Column(db.Boolean)
    # 在执行前是否需要弹框确认
    required_confirm = db.Column(db.Boolean)

    apps = db.relationship('App', secondary='deploy_app_menu_rel')

    def __repr__(self):
        return '<DeployMenu %r>' % self.name

    class Meta:
        ordering = ('-id',)


class AppMenuRel(db.Model, ModelMixin):
    __tablename__ = 'deploy_app_menu_rel'

    id = db.Column(db.Integer, primary_key=True)
    menu_id = db.Column(db.Integer, db.ForeignKey('deploy_menus.id'))
    app_id = db.Column(db.Integer, db.ForeignKey('deploy_apps.id'))

    def __eq__(self, other):
        return other.menu_id == self.menu_id and other.app_id == self.app_id


class DeployField(db.Model, ModelMixin):
    __tablename__ = 'deploy_fields'

    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(50))
    desc = db.Column(db.String(255))
    command = db.Column(db.Text)

    apps = db.relationship('App', secondary='deploy_app_field_rel')

    def __repr__(self):
        return '<DeployField %r>' % self.name


class AppFieldRel(db.Model, ModelMixin):
    __tablename__ = 'deploy_app_field_rel'

    id = db.Column(db.Integer, primary_key=True)
    field_id = db.Column(db.Integer, db.ForeignKey('deploy_fields.id'))
    app_id = db.Column(db.Integer, db.ForeignKey('deploy_apps.id'))

    def __eq__(self, other):
        return other.field_id == self.field_id and other.app_id == self.app_id'''
