from flask import Blueprint, request, g
import os
import time
from apps.exploit.models import Exploit, VulType, Category, Application, Level, Language, Effect
from apps.account.models import User
# from apps.configuration.models import ConfigKey, AppConfigRel, Environment
# from apps.assets.models import Host
from libs.tools import json_response, JsonParser, Argument, AttrDict
# from libs.utils import Container
# from docker.errors import DockerException
from datetime import datetime
# from public import db
from libs.decorators import require_permission
# from apps.deploy.utils import get_built_in_menus

blueprint = Blueprint(__name__, __name__)


@blueprint.route('/standalone_tool_upload', methods=['POST'])
@require_permission('exploit_view')
def standalone_tool_upload():
    file = request.files['standalone_tool_file']
    if file.filename.rsplit('.', 1)[1].lower() == "zip" or file.filename.rsplit('.', 1)[1].lower() == "rar":
        try:
            alise_name = str(int(time.time()))+"_"+file.filename
            upload_path = "./upload/"+str(g.user.id)+"/standalone_tools/"
            if not os.path.exists(upload_path):
                os.mkdir(upload_path)
            file.save(os.path.join(upload_path, alise_name))
            return json_response({"status": "独立利用工具上传成功", "file_list": [{"name": file.filename, "path": os.path.join(upload_path, alise_name)}]})
        except Exception:
            return json_response(message="独立利用工具上传失败")
    else:
        return json_response(message="只能上传zip或rar文件")


@blueprint.route('/plugin_remove', methods=['POST'])
@require_permission('exploit_view')
def plugin_remove():
    form, error = JsonParser(
        Argument('name', type=str),
        Argument('path', type=str)
    ).parse()
    if os.path.exists(form.path):
        try:
            os.remove(form.path)
            return json_response(data={"status": "插件删除成功"})
        except Exception:
            return json_response(message="插件删除失败")
    else:
        return json_response(message="插件删除成功")


@blueprint.route('/plugin_upload', methods=['POST'])
@require_permission('exploit_view')
def plugin_upload():
    file = request.files['plugin_file']
    if file.filename.rsplit('.', 1)[1].lower() == "py":
        try:
            alise_name = str(int(time.time()))+"_"+file.filename
            upload_path = "./upload/"+str(g.user.id)+"/plugins/"
            if not os.path.exists(upload_path):
                os.mkdir(upload_path)
            file.save(os.path.join(upload_path, alise_name))
            return json_response({"status": "插件上传成功", "file_list": [{"name": file.filename, "path": os.path.join(upload_path, alise_name)}]})
        except Exception:
            return json_response(message="插件上传失败")
    else:
        return json_response(message="只能上传py文件")


@blueprint.route('/plugins/<int:plugin_id>/extend', methods=['GET'])
@require_permission('exploit_view')
def get_extend(plugin_id):
    query = Exploit.query.join(
            Category, Category.id == Exploit.category_id).join(
                VulType, VulType.id == Exploit.vul_type_id).join(
                    Application,
                    Application.id == Exploit.application_id).join(
                        Level, Level.id == Exploit.vullevel_id).join(
                            Language, Language.id == Exploit.language_id).join(
                                Effect, Effect.id == Exploit.effect_id).join(
                                    User, User.id == Exploit.user_id).with_entities(
                                        Exploit.affect_version, Exploit.enter_time, Exploit.update_time, Language.name, Exploit.os,
                                        Exploit.desc).filter(Exploit.id == plugin_id)
    return json_response(dict(zip(['affect_version', 'enter_time', 'update_time', 'language_name', 'os', 'desc'], list(query.first()))))


@blueprint.route('/plugins/<int:plugin_id>', methods=['GET'])
@require_permission('exploit_view')
def get_plugin(plugin_id):
    query = Exploit.query.filter(Exploit.id == plugin_id)
    return json_response(query.first())


@blueprint.route('/plugins', methods=['GET'])
@require_permission('exploit_view')
def get():
    form, error = JsonParser(
        Argument('page', type=int, default=1, required=False),
        Argument('pagesize', type=int, default=10, required=False),
        Argument('plugin_query', type=dict, default={}),
    ).parse(request.args)
    if error is None:
        query = Exploit.query.join(
            Category, Category.id == Exploit.category_id).join(
                VulType, VulType.id == Exploit.vul_type_id).join(
                    Application,
                    Application.id == Exploit.application_id).join(
                        Level, Level.id == Exploit.vullevel_id).join(
                            Language, Language.id == Exploit.language_id).join(
                                Effect, Effect.id == Exploit.effect_id).join(
                                    User, User.id == Exploit.user_id).with_entities(
                                        Exploit.id, Exploit.name, Exploit.cve, VulType.name, Level.name, Effect.name, Application.name,
                                        Category.name, User.nickname)

        if form.page == -1:
            return json_response({
                'data': [x.to_json() for x in query.all()],
                'total': -1
            })
        if form.plugin_query.get('name'):
            query = query.filter(
                Exploit.name.like('%{}%'.format(form.plugin_query['name'])))

        if form.plugin_query.get('vul_type_id'):
            query = query.filter(Exploit.vul_type_id ==
                                 form.plugin_query.get('vul_type_id'))

        if form.plugin_query.get('level_id'):
            query = query.filter(Exploit.vullevel_id ==
                                 form.plugin_query.get('level_id'))

        if form.plugin_query.get('effect_id'):
            query = query.filter(Exploit.effect_id ==
                                 form.plugin_query.get('effect_id'))

        if form.plugin_query.get('application_id'):
            query = query.filter(Exploit.application_id ==
                                 form.plugin_query.get('application_id'))

        if form.plugin_query.get('category_id'):
            query = query.filter(Exploit.category_id ==
                                 form.plugin_query.get('category_id'))

        query = query.filter(Exploit.user_id == g.user.id).order_by(Exploit.id.desc())

        result = query.limit(form.pagesize).offset(
            (form.page - 1) * form.pagesize).all()
        return json_response({
            'data': [dict(zip(['id', 'exploit_name', 'cve', 'vultype_name', 'level_name', 'effect_name', 'application_name', 'category_name',
                               'author'], list(x))) for x in result],
            'total': query.count()
        })
    return json_response(message=error)


@blueprint.route('/vultypes', methods=['GET'])
@require_permission('exploit_view')
def search_vultypes():
    query = VulType.query
    vultypes = query.all()
    total = query.count()
    return json_response({'data': [x.to_json() for x in vultypes], 'total': total})


@blueprint.route('/levels', methods=['GET'])
@require_permission('exploit_view')
def search_levels():
    query = Level.query
    levels = query.all()
    total = query.count()
    return json_response({'data': [x.to_json() for x in levels], 'total': total})


@blueprint.route('/effects', methods=['GET'])
@require_permission('exploit_view')
def search_effects():
    query = Effect.query
    effects = query.all()
    total = query.count()
    return json_response({'data': [x.to_json() for x in effects], 'total': total})


@blueprint.route('/applications', methods=['GET'])
@require_permission('exploit_view')
def search_applications():
    query = Application.query
    applications = query.all()
    total = query.count()
    return json_response({'data': [x.to_json() for x in applications], 'total': total})


@blueprint.route('/categories', methods=['GET'])
@require_permission('exploit_view')
def search_categories():
    query = Category.query
    categories = query.all()
    total = query.count()
    return json_response({'data': [x.to_json() for x in categories], 'total': total})


@blueprint.route('/languages', methods=['GET'])
@require_permission('exploit_view')
def search_languages():
    query = Language.query
    languages = query.all()
    total = query.count()
    return json_response({'data': [x.to_json() for x in languages], 'total': total})


@blueprint.route('/plugins', methods=['POST'])
@require_permission('exploit_add')
def post():
    args = AttrDict(name=Argument('name', type=str, help='请输入漏洞插件名称!'),
                    cve=Argument('cve', type=str, help='请输入漏洞编号!'),
                    vul_type_id=Argument(
                        'vul_type_id', type=str, help='请选择漏洞类型!'),
                    vullevel_id=Argument('vullevel_id', type=int, help='请选择危害等级!'),
                    effect_id=Argument('effect_id', type=int, help='请选择利用效果!'),
                    application_id=Argument(
                        'application_id', type=int, help='请选择应用名称！'),
                    category_id=Argument(
                        'category_id', type=int, help='请选择应用归类！'),
                    affect_version=Argument(
                        'affect_version', type=str, help='请输入目标版本!'),
                    language_id=Argument(
                        'language_id', type=int, help='请选择应用归类！'),
                    os=Argument('os', type=str, help='请输入目标系统!'),
                    desc=Argument('desc', type=str, help='请输入漏洞描述!'))
    form, error = JsonParser(*args.values()).parse()
    if error is None:
        if Exploit.query.filter(Exploit.name == form.name).first():
            return json_response(message='漏洞插件名称不能重复！')
        plugin = Exploit(**form)
        plugin.enter_time = datetime.now()
        plugin.update_time = ""
        plugin.user_id = g.user.id
        plugin.save()
        return json_response(plugin)
    return json_response(message=error)


@blueprint.route('/plugins/<int:plugin_id>', methods=['DELETE'])
@require_permission('publish_app_del')
def delete(plugin_id):
    plugin = Exploit.query.get_or_404(plugin_id)
    plugin.delete()
    return json_response()


@blueprint.route('/plugins/<int:plugin_id>', methods=['PUT'])
@require_permission('publish_app_edit')
def put(plugin_id):
    args = AttrDict(name=Argument('name', type=str, help='请输入漏洞插件名称!'),
                    cve=Argument('cve', type=str, help='请输入漏洞编号!'),
                    vul_type_id=Argument(
                        'vul_type_id', type=str, help='请选择漏洞类型!'),
                    vullevel_id=Argument('vullevel_id', type=int, help='请选择危害等级!'),
                    effect_id=Argument('effect_id', type=int, help='请选择利用效果!'),
                    application_id=Argument(
                        'application_id', type=int, help='请选择应用名称！'),
                    category_id=Argument(
                        'category_id', type=int, help='请选择应用归类！'),
                    affect_version=Argument(
                        'affect_version', type=str, help='请输入目标版本!'),
                    language_id=Argument(
                        'language_id', type=int, help='请选择应用归类！'),
                    os=Argument('os', type=str, help='请输入目标系统!'),
                    desc=Argument('desc', type=str, help='请输入漏洞描述!'))
    form, error = JsonParser(*args.values()).parse()
    if error is None:
        exists_record = Exploit.query.filter(Exploit.name == form.name).first()
        if exists_record and exists_record.id != plugin_id:
            return json_response(message='漏洞插件名称不能重复！')
        plugin = Exploit.query.get_or_404(plugin_id)
        plugin.update(**form)
        plugin.update_time = datetime.now()
        plugin.save()
        return json_response(plugin)
    return json_response(message=error)


@blueprint.route('/receive', methods=['GET'])
# @require_permission('publish_app_view')
def fetch_groups():
    # apps = db.session.query(App.group.distinct().label('group')).all()
    print(123)
    return json_response()


'''# 用户在发布详情页获取自定义的展示字段，需具有应用发布权限
@blueprint.route('/<int:app_id>/fields', methods=['GET'])
@require_permission('publish_app_publish_view')
def fetch_fields(app_id):
    pro = App.query.get_or_404(app_id)
    return json_response(pro.fields)


# 用于在发布详情页面获取启用的自定义菜单，需具有执行自定义菜单的权限
@blueprint.route('/<int:app_id>/menus', methods=['GET'])
@require_permission('publish_app_publish_menu_exec|publish_app_menu_view')
def fetch_menus(app_id):
    q_type = request.args.get('type')
    if q_type == 'built-in':
        menus = DeployMenu.query.filter_by(app_id=app_id).all()
        built_in_menus = get_built_in_menus()
        for item in menus:
            built_in_menus[item.name]['command'] = item.command
        return json_response(list(built_in_menus.values()))
    pro = App.query.get_or_404(app_id)
    if q_type == 'all':
        menus = pro.menus[:]
        menus.extend(DeployMenu.query.filter_by(app_id=app_id).all()[:])
    else:
        menus = pro.menus
    return json_response(menus)


# 用于编辑内置发布用菜单，需要具有发布菜单编辑权限
@blueprint.route('/<int:app_id>/bind/menus', methods=['POST'])
@require_permission('publish_app_menu_edit')
def bind_menus(app_id):
    all_valid_menus = get_built_in_menus()
    form, error = JsonParser(
        Argument('name', filter=lambda x: x in all_valid_menus, help='无效的菜单名称！', default=''),
        Argument('command', default='')
    ).parse()
    if error is None:
        if form.name is '':  # 可能通过发布页提供的添加预定义菜单的请求，格式[{name: 'x', desc: 'x', command: 'x'} ...]
            post_data = request.get_json()
            if isinstance(post_data, list) and all([isinstance(x, dict) and x['name'] in all_valid_menus for x in post_data]):
                for item in post_data:
                    tmp = all_valid_menus[item['name']]
                    tmp['command'] = item.get('command')
                    tmp['app_id'] = app_id
                    DeployMenu.upsert({'app_id': app_id, 'name': item['name']}, **tmp)
                return json_response()
            else:
                return json_response(message='错误的参数！')
        form.desc = get_built_in_menus()[form.name]['desc']
        form.app_id = app_id
        DeployMenu.upsert({'app_id': app_id, 'name': form.name}, **form)
    return json_response(message=error)'''
